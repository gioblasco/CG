<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Jogo do Labirinto</title>
    <style>
    body {
        color: #ffffff;
        /*font-family:Monospace;*/
        font-size:15px;
        text-align:center;
        font-weight: bold;

        background-color: purple;
        margin: 0px;
        overflow: hidden;
        cursor: none;
    }

    </style>
</head>
<body>

    <h1 id="header" style="color:lightblue">Labirinto do Pooh</h1>
    <h3> Ajude o ursinho achar o <span id="piglet" style="color:orange">Leitão</span>, o Tigrão, sua <span id="ball" style="color:orange">bola colorida</span> e o principal, seu famigerado pote de mel</span>! </h3>

    <div id = "inicio" style="margin-top: 30em; color:lightblue">
      <h3> <span style="border: 1px solid white; border-radius: 10px; padding: 2em;">Para iniciar o jogo, pressione a tecla Espaço</span> </h3>
    </div>

    <div id = "fim" style="margin-top: 30em; color:lightblue">
      <h1> Parabéns! Você ajudou o Pooh a achar tudo o que ele queria e agora ele está muito feliz! </h1>
    </div>

    <script src="../three/three.js"></script>
    <script src="../three/OBJLoader.js"></script>
    <script src="../three/MTLLoader.js"></script>
    <script src="../three/STLLoader.js"></script>
    <script src="walls.js"></script>

    <script>

    (function(){
      document.getElementById("fim").style.display = 'none';
    })();

    var camera, scene, renderer, geometry, material, piglet, tigger, honey, sphere, light, plane,
        plane2, center, id;

    var mouseX = 0,
        mouseY = 0,
        mouseZ = 0;

    var maze = {width: 15, large:15, cellSize:500};

    var angleY=0;
    var angleX=0;

    var windowHalfX = window.innerWidth / 2;
    var windowHalfY = window.innerHeight / 1.5;
    var incrementoX = Math.PI/(windowHalfX);
    var incrementoY = Math.PI/(windowHalfY);

    var posInitial = {x:1, z:14};
    var ray;

    window.wallGeometries = [];

    document.onkeydown = checaInicio;

    // detecta espaço, remove a div de inicio e começa o jogo
		function checaInicio(e) {
		    if (e.keyCode == '32') {
           document.getElementById("inicio").remove();
		       init();
		    }
    }

    function init() {

        scene = new THREE.Scene();

        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 1, 10000);
        camera.position.x = (posInitial.x-maze.width/2)*maze.cellSize;
        camera.position.z = (posInitial.z-maze.large/2)*maze.cellSize-maze.cellSize/2;

        camera2 = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 1, 10000);
        camera2.position.x = (posInitial.x-maze.width/2)*maze.cellSize - 20;
        camera2.position.z = (posInitial.z-maze.large/2)*maze.cellSize-maze.cellSize/2 - 20;

        center = new THREE.Vector3(camera.position.x+250, 0, 0);

        geometrySphere = new THREE.SphereGeometry(50, 16, 16);
        material = new THREE.MeshBasicMaterial({color: 0x00FF00, wireframe: true, side: THREE.DoubleSide});
        geometryPlane = new THREE.PlaneGeometry(maze.width*maze.cellSize, maze.large*maze.cellSize);
        geometryPlaneBasic = new THREE.PlaneGeometry(maze.cellSize, maze.cellSize, 1, 1);

        // carrega textura do céu
        var texture = new THREE.TextureLoader().load('textures/blue.png', function(){
            renderer.render(scene, camera);
            animate();
        });
        texture.wrapS = THREE.RepeatWrapping;
        texture.wrapT = THREE.RepeatWrapping;
        texture.repeat.set(maze.width, maze.large);
        texture.needsUpdate = true;
        material = new THREE.MeshBasicMaterial({ map : texture, side: THREE.DoubleSide });

        // carrega textura do chão
        var texture2 = new THREE.TextureLoader().load('textures/grass.png', {}, function(){
            renderer.render(scene, camera);
            animate();
        });
        texture2.wrapS = THREE.RepeatWrapping;
        texture2.wrapT = THREE.RepeatWrapping;
        texture2.repeat.set(maze.width, maze.large);
        texture2.needsUpdate = true;
        material2 = new THREE.MeshBasicMaterial({ map : texture2, side: THREE.DoubleSide });

        // carrega textura das paredes
        var wallTexture = new THREE.TextureLoader().load('textures/blocks.jpeg');
        wallTexture.wrapS = THREE.RepeatWrapping;
        wallTexture.wrapT = THREE.RepeatWrapping;
        wallTexture.needsUpdate = true;

        var mtlPiglet = new THREE.MTLLoader();

        // leitão
        var posLeitao = {x: 8, z: 4};
        mtlPiglet.setPath("./objects/piglet/");
        mtlPiglet.load('Piglet.mtl', function( materials ) {
          materials.preload();
          var objLoader = new THREE.OBJLoader();
          objLoader.setMaterials( materials );
          objLoader.setPath("./objects/piglet/");
          objLoader.load('Piglet.obj', function ( object ) {
            piglet = object;
            piglet.position.z = (posLeitao.z-maze.large/2)*maze.cellSize-maze.cellSize/2 + 50;
            piglet.position.y = -210;
            piglet.position.x = (posLeitao.x-maze.width/2)*maze.cellSize - 250;
            piglet.scale.set(6, 6, 6);
            scene.add(piglet);
          } );

        } );

        var mtlTigger = new THREE.MTLLoader();

        // tigrão
        var posTigrao = {x: 12, z: 2};
        mtlTigger.setPath("./objects/tigger/");
        mtlTigger.load('Tigger.mtl', function( materials ) {
          materials.preload();
          var objLoader = new THREE.OBJLoader();
          objLoader.setMaterials( materials );
          objLoader.setPath("./objects/tigger/");
          objLoader.load('Tigger.obj', function ( object ) {
            tigger = object;
            tigger.position.z = (posTigrao.z-maze.large/2)*maze.cellSize-maze.cellSize/2 + 50;
            tigger.position.y = -210;
            tigger.position.x = (posTigrao.x-maze.width/2)*maze.cellSize - 250;
            tigger.scale.set(3, 3, 3);
            scene.add(tigger);
          } );

        } );

        var loaderHoney = new THREE.OBJLoader();

        // pote de mel
        var posMel = {x: 12, z: 14};

        // objeto simples para a bola
        var posBola = {x: 1, z: 5};
        sphere = new THREE.Mesh(geometrySphere, new THREE.MeshBasicMaterial({map: new THREE.TextureLoader().load('textures/ball_texture.png')}));
        sphere.position.z = (posBola.z-maze.large/2)*maze.cellSize-maze.cellSize/2 + 50;
        sphere.position.x = (posBola.x-maze.width/2)*maze.cellSize - 250;

        // objeto para o plano superior
        plane = new THREE.Mesh(geometryPlane, material);
        plane.side = THREE.DoubleSide;

        plane.rotation.x = -Math.PI/2;
        plane.position.y = 250;
        plane.position.x = 0;
        plane.position.z = 0;

        // objeto para o plano inferior
        plane2 = new THREE.Mesh(geometryPlane, material2);
        plane2.rotation.x = -Math.PI/2;
        plane2.position.y=-250;
        plane2.position.x = 0;
        plane2.position.z = 0;

        var wall;
        var wallMaterial = new THREE.MeshBasicMaterial({ map : wallTexture, side: THREE.DoubleSide });


    // estrutura

    //           _________parede1_________
    //           |                        |
    //           |                        |
    //           |                        |
    // parede4   |                        | parede2
    //           |                        |
    //           |            x           |
    //           |_________parede3________|

    // x é onde começa

        // povoa paredes 2 e 4
        for(var i=0; i<maze.width; i ++){
            // parede 2
            wall = new THREE.Mesh(geometryPlaneBasic, wallMaterial);
            wall.position.z = maze.large/2*maze.cellSize;
            wall.position.y = 0;
            wall.position.x = (i-maze.width/2)*maze.cellSize+maze.cellSize/2;
            scene.add(wall);
            wallGeometries.push(wall);
            // parede 4
            wall = new THREE.Mesh(geometryPlaneBasic, wallMaterial);
            wall.position.z = -maze.large/2*maze.cellSize;
            wall.position.y = 0;
            wall.position.x = (i-maze.width/2)*maze.cellSize+maze.cellSize/2;
            scene.add(wall);
            wallGeometries.push(wall);
        }

        // povoa paredes 1 e 3
        for(var i=0; i<maze.large; i ++){
            // parede 1
            wall = new THREE.Mesh(geometryPlaneBasic, wallMaterial);
            wall.position.x = maze.width/2*maze.cellSize;
            wall.rotation.y= Math.PI/2;
            wall.position.y = 0;
            wall.position.z = (i-maze.large/2)*maze.cellSize+maze.cellSize/2;
            scene.add(wall);
            wallGeometries.push(wall);
            // parede 3
            wall = new THREE.Mesh(geometryPlaneBasic, wallMaterial);
            wall.position.x = -maze.width/2*maze.cellSize;
            wall.rotation.y= Math.PI/2;
            wall.position.y = 0;
            wall.position.z = (i-maze.large/2)*maze.cellSize+maze.cellSize/2;
            scene.add(wall);
            wallGeometries.push(wall);
        }

        var offsizeX=0;
        var offsizeZ=0;

        // povoa paredes intermediarias
        for(var i = 0; i<walls.length; i++){
            wallData = walls[i];
            wall = new THREE.Mesh(geometryPlaneBasic, wallMaterial);
            if(wallData.orientation=='front'){
                offsizeX=-250;
                offsizeZ=-maze.cellSize;
            }else if(wallData.orientation=='back'){
                offsizeX=-250;
                offsizeZ=0;
            }else if(wallData.orientation=='left'){
                offsizeX=-maze.cellSize;
                offsizeZ=-250;
            }else if(wallData.orientation=='right'){
                offsizeX=0;
                offsizeZ=-250;
            }
            wall.position.x = (wallData.x-maze.width/2)*maze.cellSize+offsizeX;
            wall.rotation.y= wallData.orientation=='left'||wallData.orientation=='right'?Math.PI/2:0;
            wall.position.y = 0;
            wall.position.z = (wallData.z-maze.large/2)*maze.cellSize+offsizeZ;
            scene.add(wall);
            wallGeometries.push(wall);
        }


        scene.add(sphere);
        scene.add(plane);
        scene.add(plane2);

        //addiding some light to the scene
        light = new THREE.AmbientLight( 0xffffff );
        light.position.set( 0, 0, 1 ).normalize();

        scene.add(light);

        renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight*.75);
        window.camera = camera;
        document.body.appendChild(renderer.domElement);
        document.addEventListener('keydown', onDocumentKeyDown, false);

    };

    var bola = 0, leitao = 0, tigrao = 0, pote = 0;

    function onDocumentKeyDown(e){
        var keyCode = e.which||e.keyCode;
        //
        if(keyCode == 38){
            camera.translateZ(-30);
        }
        if(keyCode == 39){
            angleX+=incrementoX*50;
        }
        if(keyCode == 40){
            camera.translateZ(30);
        }
        if(keyCode == 37){
            angleX-=incrementoX*50;
        }
        ray = new THREE.Raycaster(camera.position, center.clone().normalize());
        ray.far=100;

        // se houver colisão com as paredes
        if(ray.intersectObjects(wallGeometries).length>0){
            if(keyCode == 38){
                camera.translateZ(30);
            }
            if(keyCode == 39){
                camera.translateX(-30);
            }
            if(keyCode == 40){
                camera.translateZ(-30);
            }
            if(keyCode == 37){
                camera.translateX(30);
            }
        }else{
            angleY+=incrementoY;
            center.y = 400*Math.sin(angleY*80);
        }
        // se houver colisão com os objetos
        if(ray.intersectObject(piglet).length>0){
            leitao = 1;
            scene.remove(piglet);
            document.getElementById('piglet').setAttribute('style','text-decoration:line-through;color:orange');
        }
        if(ray.intersectObject(sphere).length>0){
            bola = 1;
            scene.remove(sphere);
            document.getElementById('ball').setAttribute('style','text-decoration:line-through;color:orange');
        }
        // verifica se já encontrou todos os objetos (nao funciona com contador, tem que ser um pra cada obj)
        if(bola && leitao){
          document.getElementById("fim").style.display = 'block';
          cancelAnimationFrame(id);
          while(scene.children.length > 0){
            scene.remove(scene.children[0]);
          }
        }
    };

    function animate() {

        center.x = windowHalfX*32*Math.cos(angleX);
        center.z = windowHalfX*32*Math.sin(angleX);

        id = requestAnimationFrame(animate);

        piglet.rotation.y += 0.01;
        sphere.rotation.x -= 0.01;
        tigger.rotation.y += 0.01;

        camera.lookAt(center);
        renderer.render(scene, camera);

    };

    </script>
</body>
</html>
